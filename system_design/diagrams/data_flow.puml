@startuml
' æ•°æ®é“¾è·¯å…¨æ™¯æµç¨‹å›¾
' Author: é¡¹ç›®æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ
' Encoding: UTF-8

title IPæ™ºæ…§è§£ç­”ä¸“å®¶ç³»ç»Ÿ â€” æ•°æ®é“¾è·¯å…¨æ™¯å›¾

actor ç”¨æˆ·
participant å‰ç«¯
participant Backend as "åç«¯\nFlask + langgraph"
database RDS as "å…³ç³»å‹æ•°æ®åº“\n(é˜¿é‡Œäº‘ RDS - MySQL)"
database OSS as "å¯¹è±¡å­˜å‚¨\n(é˜¿é‡Œäº‘ OSS)"
participant Scheduler as "FC Scheduler\n(å®šæ—¶è§¦å‘)"
participant Parser as "FC å‡½æ•°\nDoc Parser"
participant DM as "IDP\n(é˜¿é‡Œäº‘ Document Mind)"
participant Chunker as "FC å‡½æ•°\nChunk & Embed"
participant BGE as "bge-m3 åµŒå…¥æ¨¡å‹\n(é˜¿é‡Œäº‘ PAI-EAS)"
database VectorDB as "å‘é‡æ•°æ®åº“\n(é˜¿é‡Œäº‘ OpenSearch)"
participant Retriever as "å¬å›æ¨¡å—\n(å‘é‡+BM25)"
participant Reranker as "bge-reranker ç²¾æ’æ¨¡å‹\n(é˜¿é‡Œäº‘ PAI-EAS)"
participant Bailian as "å¤§æ¨¡å‹ç”Ÿæˆ\n(é˜¿é‡Œäº‘ç™¾ç‚¼  Qwen-plus)"
participant LangSmith as "å¯è§‚æµ‹æ€§\nLangSmith"
participant Dashboard as "æ•°æ®çœ‹æ¿\nå‰ç«¯ECharts"
Backend --> LangSmith : Trace (é“¾è·¯æ—¥å¿—)

== æ–‡æ¡£å…¥åº“ (å¼‚æ­¥ä»»åŠ¡) ==
ç”¨æˆ· -> å‰ç«¯ : æ‹–æ‹½/é€‰æ‹©æ–‡ä»¶
å‰ç«¯ -> Backend : POST /knowledge/documents (multipart)
Backend -> OSS : ä¸Šä¼ åŸå§‹æ–‡ä»¶
Backend -> RDS : å†™å…¥ metadata & åˆ›å»º job (status=pending)

== æ–‡æ¡£å¤„ç† (å®šæ—¶è½®è¯¢) ==
Scheduler -> RDS : æŸ¥è¯¢ pending jobs
Scheduler -> Parser : è§¦å‘è§£æå‡½æ•° (æºå¸¦ job info)
Parser -> RDS : æ›´æ–° job status=processing
Parser -> OSS : ä¸‹è½½æ–‡ä»¶
Parser -> DM : è°ƒç”¨ IDP è§£æ (ç”µå­+OCR/NLP)
DM --> Parser : ç»“æ„åŒ– JSON/Markdown
Parser -> OSS : å­˜å‚¨ parsed æ–‡ä»¶
Parser -> RDS : æ›´æ–° doc status=PARSING
note right of Parser
  è§£æå¤±è´¥æ—¶æ›´æ–° status=FAILED
  æ”¯æŒ PUT /knowledge/documents/{docId}/reparse é‡è¯•
end note
Parser -> Chunker : ç›´æ¥è°ƒç”¨/è§¦å‘ä¸‹ä¸€æ­¥

== è¯­ä¹‰åˆ‡åˆ† & å…¥åº“ ==
Chunker -> OSS : è¯»å– parsed æ–‡ä»¶
Chunker -> BGE : æ–‡æœ¬å‘é‡åŒ–
BGE --> Chunker : å‘é‡ç»“æœ
Chunker -> VectorDB : å†™å…¥å‘é‡ + å…ƒæ•°æ®
Chunker -> RDS : æ›´æ–° doc status=INDEXED, job status=completed
note right of Chunker
  è‹¥å…¥åº“å¤±è´¥, æ›´æ–° status=FAILED
  å¹¶å¯é‡æ–°è§¦å‘åˆ‡åˆ†ä»»åŠ¡
end note

== é—®ç­”æµç¨‹ (å¬å›+ç²¾æ’) ==
ç”¨æˆ· -> å‰ç«¯ : æé—® (+ å¯é€‰æˆªå›¾)
å‰ç«¯ -> Backend : POST /cases
Backend -> Retriever : è°ƒç”¨å¬å›æ¨¡å—
Retriever -> VectorDB : æŸ¥è¯¢å‘é‡ & BM25
Retriever --> Backend : è¿”å›å€™é€‰ç‰‡æ®µ (ä¾‹å¦‚ Top 50)
Backend -> Reranker : é—®é¢˜ + å€™é€‰ç‰‡æ®µ
Reranker --> Backend : è¿”å›ç²¾æ’åç‰‡æ®µ (ä¾‹å¦‚ Top 5)
Backend -> Bailian : Prompt + ç²¾æ’å Context
Bailian --> Backend : è§£å†³æ–¹æ¡ˆ (åˆ†æ­¥éª¤/å¼•ç”¨)
Backend -> RDS : å­˜èŠ‚ç‚¹ & è¾¹
Backend -> å‰ç«¯ : è¿”å›è¯Šæ–­è·¯å¾„å›¾
å‰ç«¯ -> ç”¨æˆ· : æ¸²æŸ“æ–¹æ¡ˆ / å¼•ç”¨ / è¿›åº¦

== åé¦ˆé—­ç¯ ==
ç”¨æˆ· -> å‰ç«¯ : ğŸ‘ / ğŸ‘ åé¦ˆ
å‰ç«¯ -> Backend : POST /cases/{id}/feedback
Backend -> RDS : è®°å½•åé¦ˆ
Backend -> MQ : (å¯é€‰) æ¨é€äººå·¥å®¡æ ¸

== é™„ä»¶ä¸Šä¼  ==
ç”¨æˆ· -> å‰ç«¯ : ä¸Šä¼ æˆªå›¾ / æ—¥å¿—ç­‰é™„ä»¶
å‰ç«¯ -> Backend : POST /files (multipart)
Backend -> OSS : ä¸Šä¼ é™„ä»¶
Backend -> RDS : å†™å…¥ file metadata
Backend --> å‰ç«¯ : fileId + url

== é‰´æƒç™»å½• ==
ç”¨æˆ· -> å‰ç«¯ : è¾“å…¥ç”¨æˆ·å/å¯†ç 
å‰ç«¯ -> Backend : POST /auth/login
Backend -> RDS : æ ¡éªŒç”¨æˆ·å‡­æ®
Backend --> å‰ç«¯ : access_token (JWT)

== å¤šè½®è¿½é—® ==
loop ç”¨æˆ·è¡¥å……ä¿¡æ¯
    ç”¨æˆ· -> å‰ç«¯ : è¡¥å……ä¿¡æ¯ / ä¸Šä¼ é™„ä»¶
    å‰ç«¯ -> Backend : POST /cases/{id}/interactions
    Backend -> Retriever : è°ƒç”¨å¬å›æ¨¡å—
    Retriever -> VectorDB : æŸ¥è¯¢å‘é‡ & BM25
    Retriever --> Backend : è¿”å›å€™é€‰ç‰‡æ®µ
    Backend -> Reranker : é—®é¢˜ + å€™é€‰ç‰‡æ®µ
    Reranker --> Backend : è¿”å›ç²¾æ’åç‰‡æ®µ
    Backend -> Bailian : ç”Ÿæˆåˆ†æ / è¿½é—® / æ–¹æ¡ˆ
    Backend -> RDS : å­˜æ–°å¢èŠ‚ç‚¹ & è¾¹
    Backend --> å‰ç«¯ : newNodes / newEdges
    å‰ç«¯ -> ç”¨æˆ· : æ›´æ–°ç”»å¸ƒ
end loop

== ç»Ÿè®¡æ•°æ®çœ‹æ¿ ==
å‰ç«¯ -> Backend : GET /statistics
Backend -> RDS : èšåˆç»Ÿè®¡
Backend --> å‰ç«¯ : JSON stats
å‰ç«¯ -> Dashboard : æ¸²æŸ“å›¾è¡¨

@enduml