@startuml
' æ•°æ®é“¾è·¯å…¨æ™¯æµç¨‹å›¾
' Author: é¡¹ç›®æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ
' Encoding: UTF-8

title IPæ™ºæ…§è§£ç­”ä¸“å®¶ç³»ç»Ÿ â€” æ•°æ®é“¾è·¯æµç¨‹å›¾

actor ç”¨æˆ·
participant å‰ç«¯
participant Backend as "åç«¯\nFlask + langgraph"
database RDS as "å…³ç³»å‹æ•°æ®åº“\nMySQL"
database OSS as "å¯¹è±¡å­˜å‚¨ OSS"
queue MQ as "doc-parse-jobs\n(MNS / Kafka)"
participant Parser as "FC å‡½æ•°\nDoc Parser"
participant DM as "æ–‡æ¡£æ™ºèƒ½\nDocument Mind"
participant Chunker as "FC å‡½æ•°\nChunk & Embed"
participant BGE as "BGE åµŒå…¥æ¨¡å‹\nPAI-EAS"
database VectorDB as "å‘é‡æ•°æ®åº“\nWeaviate"
participant Retriever as "æ··åˆæ£€ç´¢\nEnsembleRetriever"
participant Qwen as "å¤§æ¨¡å‹ç”Ÿæˆ\nQwen (PAI-EAS)"
participant LangSmith as "å¯è§‚æµ‹æ€§\nLangSmith"
participant Dashboard as "æ•°æ®çœ‹æ¿\nå‰ç«¯ECharts"
Backend --> LangSmith : Trace (é“¾è·¯æ—¥å¿—)

== æ–‡æ¡£å…¥åº“ ==
ç”¨æˆ· -> å‰ç«¯ : æ‹–æ‹½/é€‰æ‹©æ–‡ä»¶
å‰ç«¯ -> Backend : POST /knowledge/documents (multipart)
Backend -> OSS : ä¸Šä¼ åŸå§‹æ–‡ä»¶
Backend -> RDS : å†™å…¥ metadata (status=UPLOADING)
Backend -> MQ : æ¨é€è§£æä»»åŠ¡

== æ–‡æ¡£è§£æ ==
MQ -> Parser : è§¦å‘è§£æå‡½æ•°
Parser -> OSS : ä¸‹è½½æ–‡ä»¶
Parser -> DM : è°ƒç”¨ IDP è§£æ (ç”µå­+OCR/NLP)
DM --> Parser : ç»“æ„åŒ– JSON/Markdown
Parser -> OSS : å­˜å‚¨ parsed æ–‡ä»¶
Parser -> RDS : æ›´æ–° status=PARSING
note right of Parser
  è§£æå¤±è´¥æ—¶æ›´æ–° status=FAILED
  æ”¯æŒ PUT /knowledge/documents/{docId}/reparse é‡è¯•
end note
Parser -> MQ : æ¨é€åˆ‡åˆ†ä»»åŠ¡

== è¯­ä¹‰åˆ‡åˆ† & å…¥åº“ ==
MQ -> Chunker : è§¦å‘åˆ‡åˆ†å‡½æ•°
Chunker -> OSS : è¯»å– parsed æ–‡ä»¶
Chunker -> BGE : æ–‡æœ¬å‘é‡åŒ–
BGE --> Chunker : å‘é‡ç»“æœ
Chunker -> VectorDB : å†™å…¥å‘é‡ + å…ƒæ•°æ®
Chunker -> RDS : æ›´æ–° status=INDEXED
note right of Chunker
  è‹¥å…¥åº“å¤±è´¥, æ›´æ–° status=FAILED
  å¹¶å¯é‡æ–°è§¦å‘åˆ‡åˆ†ä»»åŠ¡
end note

== é—®ç­”æµç¨‹ ==
ç”¨æˆ· -> å‰ç«¯ : æé—® (+ å¯é€‰æˆªå›¾)
å‰ç«¯ -> Backend : POST /cases
Backend -> Retriever : è°ƒç”¨æ··åˆæ£€ç´¢å™¨
Retriever -> VectorDB : æŸ¥è¯¢å‘é‡ & BM25
Retriever --> Backend : Top-K ç‰‡æ®µ
Backend -> Qwen : Prompt + Context
Qwen --> Backend : è§£å†³æ–¹æ¡ˆ (åˆ†æ­¥éª¤/å¼•ç”¨)
Backend -> RDS : å­˜èŠ‚ç‚¹ & è¾¹
Backend -> å‰ç«¯ : è¿”å›è¯Šæ–­è·¯å¾„å›¾
å‰ç«¯ -> ç”¨æˆ· : æ¸²æŸ“æ–¹æ¡ˆ / å¼•ç”¨ / è¿›åº¦

== åé¦ˆé—­ç¯ ==
ç”¨æˆ· -> å‰ç«¯ : ğŸ‘ / ğŸ‘ åé¦ˆ
å‰ç«¯ -> Backend : POST /cases/{id}/feedback
Backend -> RDS : è®°å½•åé¦ˆ
Backend -> MQ : (å¯é€‰) æ¨é€äººå·¥å®¡æ ¸

== é™„ä»¶ä¸Šä¼  ==
ç”¨æˆ· -> å‰ç«¯ : ä¸Šä¼ æˆªå›¾ / æ—¥å¿—ç­‰é™„ä»¶
å‰ç«¯ -> Backend : POST /files (multipart)
Backend -> OSS : ä¸Šä¼ é™„ä»¶
Backend -> RDS : å†™å…¥ file metadata
Backend --> å‰ç«¯ : fileId + url

== é‰´æƒç™»å½• ==
ç”¨æˆ· -> å‰ç«¯ : è¾“å…¥ç”¨æˆ·å/å¯†ç 
å‰ç«¯ -> Backend : POST /auth/login
Backend -> RDS : æ ¡éªŒç”¨æˆ·å‡­æ®
Backend --> å‰ç«¯ : access_token (JWT)

== å¤šè½®è¿½é—® ==
loop ç”¨æˆ·è¡¥å……ä¿¡æ¯
    ç”¨æˆ· -> å‰ç«¯ : è¡¥å……ä¿¡æ¯ / ä¸Šä¼ é™„ä»¶
    å‰ç«¯ -> Backend : POST /cases/{id}/interactions
    Backend -> Retriever : æ··åˆæ£€ç´¢ (EnsembleRetriever)
    Retriever -> VectorDB : æŸ¥è¯¢å‘é‡ & BM25
    Backend -> Qwen : ç”Ÿæˆåˆ†æ / è¿½é—® / æ–¹æ¡ˆ
    Backend -> RDS : å­˜æ–°å¢èŠ‚ç‚¹ & è¾¹
    Backend --> å‰ç«¯ : newNodes / newEdges
    å‰ç«¯ -> ç”¨æˆ· : æ›´æ–°ç”»å¸ƒ
end loop

== ç»Ÿè®¡æ•°æ®çœ‹æ¿ ==
å‰ç«¯ -> Backend : GET /statistics
Backend -> RDS : èšåˆç»Ÿè®¡
Backend --> å‰ç«¯ : JSON stats
å‰ç«¯ -> Dashboard : æ¸²æŸ“å›¾è¡¨

@enduml 