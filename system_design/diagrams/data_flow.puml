@startuml DataFlow
' æ•°æ®é“¾è·¯å…¨æ™¯æµç¨‹å›¾ (æœ¬åœ°åŒ–éƒ¨ç½²ç‰ˆæœ¬)
' Author: é¡¹ç›®æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ
' Encoding: UTF-8

title IPæ™ºæ…§è§£ç­”ä¸“å®¶ç³»ç»Ÿ â€” æ•°æ®é“¾è·¯å…¨æ™¯å›¾

actor ç”¨æˆ·
participant å‰ç«¯
participant Backend as "åç«¯\n(æœ¬åœ° Flask)"
database RDS as "å…³ç³»å‹æ•°æ®åº“\n(Docker MySQL)"
participant LocalStorage as "æœ¬åœ°æ–‡ä»¶å­˜å‚¨"
participant Worker as "åå°ä»»åŠ¡\n(RQ)"
participant DM as "æ–‡æ¡£æ™ºèƒ½è§£æ\n(é˜¿é‡Œäº‘IDP)"
participant BGE as "text-embedding-v4 å‘é‡æ¨¡å‹\n(é˜¿é‡Œäº‘ç™¾ç‚¼å¹³å°)"
database VectorDB as "å‘é‡æ•°æ®åº“\n(Docker Weaviate)"
participant Retriever as "å¬å›æ¨¡å—\n(å‘é‡+BM25)"
participant Reranker as "Qwen3-Reranker é‡æ’åºæ¨¡å‹\n(OLLAMA æœ¬åœ°éƒ¨ç½²)"
participant Bailian as " Qwen-plus å¤§æ¨¡å‹ç”Ÿæˆæœ€ç»ˆå›å¤\n(é˜¿é‡Œäº‘ç™¾ç‚¼)"
participant LangSmith as "å¯è§‚æµ‹æ€§(å¯é€‰)\n(LangSmith)"
participant Dashboard as "æ•°æ®çœ‹æ¿\nå‰ç«¯ECharts"

Backend --> LangSmith : Trace (é“¾è·¯æ—¥å¿—)

== æ–‡æ¡£å…¥åº“ (å¼‚æ­¥ä»»åŠ¡) ==
ç”¨æˆ· -> å‰ç«¯ : æ‹–æ‹½/é€‰æ‹©æ–‡ä»¶
å‰ç«¯ -> Backend : POST /knowledge/documents (multipart)
Backend -> LocalStorage : ä¸Šä¼ åŸå§‹æ–‡ä»¶
Backend -> RDS : å†™å…¥ metadata & åˆ›å»º job (status=pending)

== æ–‡æ¡£å¤„ç† (åå°ä»»åŠ¡) ==
Backend -> Worker : è§¦å‘å¼‚æ­¥è§£æä»»åŠ¡ (æºå¸¦ job info)
Worker -> RDS : æ›´æ–° job status=processing
Worker -> LocalStorage : è¯»å–æ–‡ä»¶
Worker -> DM : è°ƒç”¨ IDP è§£æ (ç”µå­+OCR/NLP)
DM --> Worker : ç»“æ„åŒ– JSON/Markdown
Worker -> LocalStorage : å­˜å‚¨ parsed æ–‡ä»¶
Worker -> BGE : æ–‡æœ¬å‘é‡åŒ–
BGE --> Worker : å‘é‡ç»“æœ
Worker -> VectorDB : å†™å…¥å‘é‡ + å…ƒæ•°æ®
Worker -> RDS : æ›´æ–° doc status=INDEXED, job status=completed
note right of Worker
  è‹¥å¤„ç†å¤±è´¥, æ›´æ–° status=FAILED
  æ”¯æŒ PUT /knowledge/documents/{docId}/reparse é‡è¯•
end note

== é—®ç­”æµç¨‹ (å¬å›+ç²¾æ’) ==
ç”¨æˆ· -> å‰ç«¯ : æé—® (+ å¯é€‰æˆªå›¾)
å‰ç«¯ -> Backend : POST /cases
Backend -> Retriever : è°ƒç”¨å¬å›æ¨¡å—
Retriever -> VectorDB : æŸ¥è¯¢å‘é‡ & BM25
Retriever --> Backend : è¿”å›å€™é€‰ç‰‡æ®µ (ä¾‹å¦‚ Top 50)
Backend -> Reranker : é—®é¢˜ + å€™é€‰ç‰‡æ®µ
Reranker --> Backend : è¿”å›ç²¾æ’åç‰‡æ®µ (ä¾‹å¦‚ Top 5)
Backend -> Bailian : Prompt + ç²¾æ’å Context
Bailian --> Backend : è§£å†³æ–¹æ¡ˆ (åˆ†æ­¥éª¤/å¼•ç”¨)
Backend -> RDS : å­˜èŠ‚ç‚¹ & è¾¹
Backend -> å‰ç«¯ : è¿”å›è¯Šæ–­è·¯å¾„å›¾
å‰ç«¯ -> ç”¨æˆ· : æ¸²æŸ“æ–¹æ¡ˆ / å¼•ç”¨ / è¿›åº¦

== åé¦ˆé—­ç¯ ==
ç”¨æˆ· -> å‰ç«¯ : ğŸ‘ / ğŸ‘ åé¦ˆ
å‰ç«¯ -> Backend : POST /cases/{id}/feedback
Backend -> RDS : è®°å½•åé¦ˆ

== é™„ä»¶ä¸Šä¼  ==
ç”¨æˆ· -> å‰ç«¯ : ä¸Šä¼ æˆªå›¾ / æ—¥å¿—ç­‰é™„ä»¶
å‰ç«¯ -> Backend : POST /files (multipart)
Backend -> LocalStorage : ä¸Šä¼ é™„ä»¶
Backend -> RDS : å†™å…¥ file metadata
Backend --> å‰ç«¯ : fileId + url (æœ¬åœ°è·¯å¾„)

== é‰´æƒç™»å½• ==
ç”¨æˆ· -> å‰ç«¯ : è¾“å…¥ç”¨æˆ·å/å¯†ç 
å‰ç«¯ -> Backend : POST /auth/login
Backend -> RDS : æ ¡éªŒç”¨æˆ·å‡­æ®
Backend --> å‰ç«¯ : access_token (JWT)

== å¤šè½®è¿½é—® ==
loop ç”¨æˆ·è¡¥å……ä¿¡æ¯
    ç”¨æˆ· -> å‰ç«¯ : è¡¥å……ä¿¡æ¯ / ä¸Šä¼ é™„ä»¶
    å‰ç«¯ -> Backend : POST /cases/{id}/interactions
    Backend -> Retriever : è°ƒç”¨å¬å›æ¨¡å—
    Retriever -> VectorDB : æŸ¥è¯¢å‘é‡ & BM25
    Retriever --> Backend : è¿”å›å€™é€‰ç‰‡æ®µ
    Backend -> Reranker : é—®é¢˜ + å€™é€‰ç‰‡æ®µ
    Reranker --> Backend : è¿”å›ç²¾æ’åç‰‡æ®µ
    Backend -> Bailian : ç”Ÿæˆåˆ†æ / è¿½é—® / æ–¹æ¡ˆ
    Backend -> RDS : å­˜æ–°å¢èŠ‚ç‚¹ & è¾¹
    Backend --> å‰ç«¯ : newNodes / newEdges
    å‰ç«¯ -> ç”¨æˆ· : æ›´æ–°ç”»å¸ƒ
end loop

== ç»Ÿè®¡æ•°æ®çœ‹æ¿ ==
participant Dashboard as "æ•°æ®çœ‹æ¿\n(å‰ç«¯ ECharts)"
å‰ç«¯ -> Backend : GET /statistics
Backend -> RDS : èšåˆç»Ÿè®¡
Backend --> å‰ç«¯ : JSON stats
å‰ç«¯ -> Dashboard : æ¸²æŸ“å›¾è¡¨

@enduml